<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
</head>
	<body>
		
		<p id="money">0</p>
		
		<p align="centre">
			<button id="mainClicker">Click Me</button>
			<button id="NEO" disabled>Buy Kamigawa</button>
		</p>

		<div class="modal fade modal-lg" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		      </div>
		      <div class="modal-body" style="text-align: center;">
		        <img id="packOpeningCards"></img>
		      </div>
		      <div class="modal-footer">
		        <button type="button" id="closeModalButton" style="display: none;" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		        <button type="button" id="nextCardButton" class="btn btn-secondary">Next</button>
		      </div>
		    </div>
		  </div>
		</div>


		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.6.1.min.js" 
		integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
  		crossorigin="anonymous">  			
  		</script>
		<script type="text/javascript" src="data.js"></script>
		<script type="text/javascript">

		var count = 10;
		var cards = JSON.parse(data);
		var pack, types, freq

		var rareArr = Object.entries(cards[0].data.booster.arena.sheets.rareMythic.cards)
		var uncommonArr = Object.entries(cards[0].data.booster.arena.sheets.sfcUncommon.cards)
		var commonUncommonArr = Object.entries(cards[0].data.booster.arena.sheets.dfcCommonUncommon.cards)
		var commonArr = Object.entries(cards[0].data.booster.arena.sheets.sfcCommon.cards)
		var landArr = Object.entries(cards[0].data.booster.arena.sheets.land.cards)

		$(document).ready(function(){
			
		})

		function getRandomInt(max) {
  			return Math.floor(Math.random() * max);
		}

		$('#mainClicker').on('click', () =>
		{
			count = count+0.5;
			$('#money').text(Math.round(count*100)/100)

			if (count > 2) {
				$('#NEO').removeAttr('disabled')
			} else {
				$('#NEO').prop('disabled', true)
			}			
		})

		$('#nextCardButton').on('click', () =>
		{
			populateModal()
		})

		$('#NEO').on('click', async function()
		{
			$('#exampleModal').modal('toggle')
			$('#closeModalButton').css('display', 'none')
			$('#nextCardButton').css('display', 'inline-block')
			count = count - 2
			$('#money').text(Math.round(count*100)/100)	
			getPackCards()
			populateModal()			

		})

		//FIX SOME URI ISSUES IN GETS
		async function getUncommonCard() {
			var uncommonCardId = uncommonArr[getRandomInt(uncommonArr.length)][0]
			let obj = cards[0].data.cards.find(o => o.uuid == uncommonCardId);
		  	$.get("https://api.scryfall.com/cards/"+obj.identifiers.scryfallId, function(data){
				$('#packOpeningCards').prop('src',data.image_uris.normal)
			});	
		}

		async function getCommonUncommonCard() {
			var commonUncommonCardId = commonUncommonArr[getRandomInt(commonUncommonArr.length)][0]
			let obj = cards[0].data.cards.find(o => o.uuid == commonUncommonCardId);
		  	$.get("https://api.scryfall.com/cards/"+obj.identifiers.scryfallId, function(data){
				$('#packOpeningCards').prop('src',data.image_uris.normal)
			});	
		}

		async function getCommonCard() {
			var commonCardId = commonArr[getRandomInt(commonArr.length)][0]
			let obj = cards[0].data.cards.find(o => o.uuid == commonCardId);
		  	$.get("https://api.scryfall.com/cards/"+obj.identifiers.scryfallId, function(data){
				$('#packOpeningCards').prop('src',data.image_uris.normal)
			});	
		}

		async function getLandCard() {
			var landCardId = landArr[getRandomInt(landArr.length)][0]
			let obj = cards[0].data.cards.find(o => o.uuid == landCardId);
		  	$.get("https://api.scryfall.com/cards/"+obj.identifiers.scryfallId, function(data){
				$('#packOpeningCards').prop('src',data.image_uris.normal)    				
			});	
		}

		async function getRareCard() {
			var rareCardId = rareArr[getRandomInt(rareArr.length)][0]
			let obj = cards[0].data.cards.find(o => o.uuid == rareCardId);
		  	$.get("https://api.scryfall.com/cards/"+obj.identifiers.scryfallId, function(data){
		  		if (data.image_uris.normal) {
					$('#packOpeningCards').prop('src',data.image_uris.normal)
				} else {
					$('#packOpeningCards').prop('src',data.image_uris.small)
				}
			});	
		}

		function getPackCards(){
			pack = cards[0].data.booster.arena.boosters[0].contents
			types = Object.keys(pack)
			freq = Object.values(pack)
		}

		//Make this switch work proper
		async function populateModal(){			
			if (freq[0] > 0) {
				switch(types[0]){
					case 'land': 
						await getLandCard()
						break

					case 'sfcCommon': 
						await getCommonCard()
						break

					case 'dfcCommonUncommon': 
						getCommonUncommonCard()
						break

					case 'sfcUncommon': 
						await getUncommonCard()
						break

					case 'rareMythic': 
						await getRareCard()
						break
				}
				freq[0] = freq[0]-1
				if (freq[0] == 0) {
					freq.shift()
					types.shift()
					if (freq[0] == undefined){
						$('#nextCardButton').css('display', 'none')
						$('#closeModalButton').css('display', 'inline-block')
					}
				}
			}			
		}



		</script>

	</body>
</html>